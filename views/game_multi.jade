extends layout

block scripts
    script(src='/socket.io/socket.io.js')
    script(src='/scripts/game_multi.js')
    script.
        var data = !{JSON.stringify(data)};
    
block content
    h1
        a(href="/")= title
    h1
        a(href="/" + data.game.id + "/_api/game", target="_blank")= data.game.id
    div#game
        div
            h2 Current Player
            <!-- ko with: currentPlayer -->
            table
                tr
                    td Name
                    td
                        div(data-bind="text: name")
                tr(data-bind="visible: $parent.phase() !== 'init' || $parent.debug")
                    td Affiliation
                    td(data-bind="text: affiliationName")
                tr(data-bind="visible: $parent.phase() === 'init' || $parent.debug")
                    td Init
                    td
                        button(data-bind="click: join") Join
                        button(data-bind="click: leave") Leave
                        div(data-bind="visible: playerIndex() !== -1")
                            input#isReady(type="checkbox", data-bind="checked: isReady, click: save")
                            label(for="isReady") Ready?
                tr(data-bind="visible: $parent.isLeader() || $parent.debug")
                    td(data-bind="text: 'Nominate ' + $parent.teamSize()")
                    td
                        <!-- ko foreach: $parent.players -->
                        div
                            input(type="checkbox", data-bind="checked: isSelected, attr: { id: 'nominate' + $index() }")
                            label(data-bind="text: name, attr: { for: 'nominate' + $index() }")
                        <!-- /ko -->
                        button(data-bind="click: $parent.submitNominees") OK
                tr(data-bind="visible: $parent.phase() === 'vote' || $parent.debug")
                    td Vote
                    td
                        input#approveVote.toggle-button(type="checkbox", data-bind="checked: voteApproved(), click: vote.bind($data, true)")
                        label(for="approveVote") Approve
                        input#rejectVote.toggle-button(type="checkbox", data-bind="checked: voteRejected(), click: vote.bind($data, false)")
                        label(for="rejectVote") Reject
                    td(data-bind="text: voteApprove")
                tr(data-bind="visible: ($parent.phase() === 'mission' && nominee()) || $parent.debug")
                    td Mission
                    td
                        input#succeedMission.toggle-button(type="checkbox", data-bind="checked: missionSucceeded(), click: mission.bind($data, true)")
                        label(for="succeedMission") Succeed
                        input#failMission.toggle-button(type="checkbox", data-bind="checked: missionFailed(), click: mission.bind($data, false)")
                        label(for="failMission") Fail
                    td(data-bind="text: missionSuccess")
            <!-- /ko -->
        div(data-bind="visible: phase() !== 'init' || debug")
            h2 Game
            table
                tr(data-bind="visible: hasTeamMates || debug")
                    td Teammates
                    td
                        <!-- ko foreach: teamMates -->
                        div(data-bind="text: name")
                        <!-- /ko -->
                tr
                    td Score
                    td
                        <!-- ko foreach: scores -->
                        div(data-bind="text: $data")
                        <!-- /ko -->
                tr
                    td Current Round
                    td(data-bind="text: currentRound() + 1")
                tr
                    td Phase
                    td(data-bind="text: phase")
                tr
                    td Team Size
                    td(data-bind="text: teamSize")
                tr(data-bind="visible: phase() !== 'nominate' || debug")
                    td Candidates
                    td
                        <!-- ko foreach: candidates -->
                        div(data-bind="text: name")
                        <!-- /ko -->
        div(data-bind="visible: phase() !== 'final' || debug")
            h2 Players
            <!-- ko foreach: players -->
            div(data-bind="text: name() + ($index() === $parent.leaderIndex() ? ' *' : '') + ($parent.phase() === 'init' && isReady() ? ' (ready)' : '')")
            <!-- /ko -->
        div(data-bind="visible: debug")
            h2 Impersonate
            button(data-bind="click: unimpersonate") unimpersonate
            table
                tr
                    th Impersonate
                    th Id
                    th Name
                    th Actions
                    th Vote
                    th Mission
                <!-- ko foreach: players -->
                tr
                    td
                        button(data-bind="click: impersonate") impersonate
                    td(data-bind="text: id")
                    td(data-bind="text: name")
                    td
                        input(type="checkbox", data-bind="checked: isReady, attr: { id: 'isReady' + $index() }")
                        label(data-bind="attr: { for: 'isReady' + $index() }") Ready?
                        button(data-bind="click: save") Save
                        button(data-bind="click: join") Join
                        button(data-bind="click: leave") Leave
                    td
                        button(data-bind="click: vote.bind($data, true)") Approve
                        button(data-bind="click: vote.bind($data, false)") Reject
                    td
                        button(data-bind="click: mission.bind($data, true)") Succeed
                        button(data-bind="click: mission.bind($data, false)") Fail
                <!-- /ko -->
        div(data-bind="visible: phase () !== 'init' || debug")
            h2 History
            <!-- ko foreach: rounds -->
            h3
                span(data-bind="text: 'Round ' + ($index() + 1)")
            table
                tr
                    td Success
                    td(data-bind="text: result")
                tr
                    td Failed nominations
                    td(data-bind="text: failedVoteCount")
                tr
                    td Mission failures
                    td(data-bind="text: failCount")
            <!-- ko foreach: history -->
            h4(data-bind="text: 'Team ' + ($index() + 1)")
            table
                tr
                    td Leader
                    td(data-bind="text: leader().name")
                tr
                    td Team
                    td
                        <!-- ko foreach: teamMembers -->
                        div(data-bind="text: name")
                        <!-- /ko -->
                tr
                    td Approve
                    td(data-bind="text: voteCounts().approveCount")
                tr
                    td Reject
                    td(data-bind="text: voteCounts().rejectCount")
                tr
                    td Votes
                    td
                        <!-- ko foreach: playerIterations -->
                        div
                            span(data-bind="text: name")
                            span : 
                            span(data-bind="text: voteDecision")
                        <!-- /ko -->
            <!-- /ko -->
            <!-- /ko -->